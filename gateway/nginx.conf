# Gateway NGINX Configuration
#
# Purpose: Serves as the API gateway and static file server for the microservices architecture
#
# Features:
# - Auto-scales worker processes based on available CPU cores
# - Routes requests to three microservices: users, orders, and inventory
# - Normalizes URLs by redirecting paths without trailing slashes
# - Serves static frontend files with SPA fallback support
#
# Upstream Services:
# - users_upstream: User service running on port 8000
# - orders_upstream: Order service running on port 8000
# - inventory_upstream: Inventory service running on port 8000
#
# Routing Rules:
# - /users/ -> proxied to users microservice
# - /orders/ -> proxied to orders microservice
# - /inventory/ -> proxied to inventory microservice
# - / -> serves static files from /usr/share/nginx/html with SPA routing support
#
# Configuration Details:
# - Worker connections: 1024 per process
# - Keepalive timeout: 65 seconds
# - Listens on port 80 (HTTP)
worker_processes auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  sendfile      on;
  keepalive_timeout  65;

  upstream users_upstream { server users:8000; }
  upstream orders_upstream { server orders:8000; }
  upstream inventory_upstream { server inventory:8000; }
  upstream web_upstream { server web:80; }

  server {
    listen 80;

    # Normalize no-trailing-slash to trailing-slash
    location = /users { return 301 /users/; }
    location = /orders { return 301 /orders/; }
    location = /inventory { return 301 /inventory/; }

    # API routing
    location /users/ {
      proxy_pass http://users_upstream/;
    }
    location /orders/ {
      proxy_pass http://orders_upstream/;
    }
    location /inventory/ {
      proxy_pass http://inventory_upstream/;
    }

    # Proxy to web application
    location / {
      proxy_pass http://web_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }
}
